---

stages:
  - âš’ï¸tool creation
  - ğŸ‰lint_test
  - ğŸš€prepare_system

variables:
  ANSIBLE_PYTHON_INTERPRETER: /usr/bin/python3
  ANSIBLE_ROLES_PATH: roles
  ANSIBLE_REMOTE_TMP: /tmp
  ANSIBLE_FORCE_COLOR: 'true'
  ANSIBLE_STARATEGY: linear
  ANSIBLE_PIPELINING: 1
  ANSIBLE_TRANSPORT: ssh
  ANSIBLE_BECOME_METHOD: su # Ğ½ÑƒĞ¶Ğ½Ğ¾ ĞµÑĞ»Ğ¸ Ğ¿Ğ¾Ğ´Ğ½Ğ¸Ğ¼Ğ°ÑÑ‚ÑÑ Ğ¿Ñ€Ğ°Ğ²Ğ° Ñ‡ĞµÑ€ĞµĞ· su Ñ Ğ²Ğ²Ğ¾Ğ´Ğ¾Ğ¼ Ğ¿Ğ°Ñ€Ğ¾Ğ»Ñ Ğ¾Ñ‚ root
  ANSIBLE_BECOME_USER: root
  ANSIBLE_BECOME_ASKPASS: 'False'
  ANSIBLE_FORCE_HANDLER: 'True'
  ANSIBLE_STDOUT_CALLBACK: "ansible.builtin.default"
  ANSIBLE_ASK_PASS: 'False'
  ANSIBLE_NOCOWS: 1
  ANSIBLE_HOST_KEY_CHECKING: 'false'
  DEPRECATION_WARNINGS: 'false'
  ANSIBLE_TIMEOUT: 30
  ANSIBLE_BECOME_EXE: 'sudo -p "Password: " su -'
  
.job_inj:
  before_script:
    - rm .gitlab-ci.yml
    - eval $(ssh-agent -s)
    - echo "$SSH_ROOT_PRIVATE_KEY" | tr -d '\r' | ssh-add -

ğŸ”¨generate_inventory:
  stage: âš’ï¸tool creation
  tags:
    - Docker
  image: alpine
  before_script:
    - apk add jq yq
  script:
    - |
      jq '
      {
        rabbitmq: {
          hosts: .hosts | map(select(.name | test("^rabbitmq")))
            | map({(.name): {ansible_host: .ip, ansible_ssh_user: "ansible"}}) | add
        },
        haproxy: {
          hosts: .hosts | map(select(.name == "haproxy")) 
            | map({"haproxy1": {ansible_host: .ip, ansible_ssh_user: "ansible"}}) | add
        }
      }' $SERVERS  | yq eval -P - > hosts.yml
  artifacts:
    paths:
      - hosts.yml
    expire_in: 1 hour

image: registry.gitlab.com/ansible_playbooks7843206/best_practices_alpine/ee:latest

ğŸ‰ansible_lint_test:
  stage: ğŸ‰lint_test
  dependencies:
    - ğŸ”¨generate_inventory
  tags:
    - Docker
  extends: .job_inj
  script:
    - ansible --version
    - ansible-lint --version
    - cat hosts.yml
    - ansible-lint -q --offline
    - ansible all -i hosts.yml -m ping


ğŸš€ansible_system:
  stage: ğŸš€prepare_system
  tags:
    - Docker
  when: manual
  dependencies:
    - ğŸ”¨generate_inventory
  extends: .job_inj
  script:
    - ansible-playbook -i hosts.yml playbooks/rabbitmq.yml
    - ansible-playbook -i hosts.yml playbooks/haproxy.yml
